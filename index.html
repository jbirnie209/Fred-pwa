<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>US Indicators (Debug)</title>
<meta name="theme-color" content="#111111" />
<style>
  :root { color-scheme: light dark; }
  body { margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:Canvas; color:CanvasText; }
  header { position:sticky; top:0; backdrop-filter:blur(10px); background:color-mix(in oklab, Canvas 80%, transparent); border-bottom:1px solid color-mix(in oklab, CanvasText 12%, transparent); padding:10px 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  h1 { font-size:17px; margin:0; flex:1; }
  button { border:1px solid color-mix(in oklab, CanvasText 20%, transparent); background:color-mix(in oklab, Canvas 90%, CanvasText 5%); color:CanvasText; border-radius:9px; padding:8px 12px; }
  .wrap { padding:10px; display:grid; gap:14px; }
  .card { border:1px solid color-mix(in oklab, CanvasText 15%, transparent); border-radius:12px; padding:10px; background:color-mix(in oklab, Canvas 92%, CanvasText 4%); }
  .title { font-weight:600; font-size:14px; margin:6px 0 10px; }
  .foot { font-size:12px; opacity:.7; margin-top:8px; }
  .error { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; border-left:4px solid #d33; padding:8px 10px; background:color-mix(in oklab, Canvas 90%, #d33 8%); }
</style>
<!-- Try primary Plotly CDN; if blocked, uncomment the alternate below -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/plotly.min.js" defer></script> -->
<script>
const FRED_API_KEY = "63a8a3d8e203adfae3c7c2570e8bb26b"; // <-- paste real key between quotes

const SERIES = { HY_OAS:"BAMLH0A0HYM2", DGS10:"DGS10", DGS1:"DGS1", TIPS10:"DFII10" };
const MS_PER_DAY = 86400000;

const logEl = ()=>document.getElementById("log");
function log(msg){ console.log(msg); const el=logEl(); if(el){ el.textContent += (el.textContent? "\n":"") + msg; } }
function showErr(err){ const el=logEl(); if(el){ el.classList.add("error"); el.textContent = String(err); } else { alert(String(err)); } }

function fmt2(x){ return Number(x).toFixed(2); }
function toDate(s){ const [y,m,d]=s.split("-").map(Number); return new Date(Date.UTC(y,m-1,d)); }

async function fredSeries(seriesId, startDateISO){
  const u = new URL("https://api.stlouisfed.org/fred/series/observations");
  u.searchParams.set("series_id", seriesId);
  u.searchParams.set("api_key", FRED_API_KEY);
  u.searchParams.set("file_type", "json");
  u.searchParams.set("frequency", "d");
  if(startDateISO) u.searchParams.set("observation_start", startDateISO);

  log("GET " + u.toString());
  let r;
  try { r = await fetch(u); }
  catch(e){ throw new Error("Network error fetching " + seriesId + ": " + e.message); }

  if(!r.ok){
    let body="";
    try{ body = await r.text(); } catch {}
    throw new Error(`FRED HTTP ${r.status} for ${seriesId}\n` + body.slice(0,500));
  }
  let j;
  try{ j = await r.json(); }
  catch(e){ throw new Error("JSON parse error for " + seriesId + ": " + e.message); }

  if(!j.observations){ throw new Error("Malformed response for "+seriesId+": " + JSON.stringify(j).slice(0,200)); }

  return j.observations
    .filter(o => o.value !== "." && o.date)
    .map(o => ({ t: toDate(o.date), v: Number(o.value) }))
    .sort((a,b)=>a.t-b.t);
}

function rollingMedian(series, years=10){
  if(!series.length) return [];
  const out = []; let start=0;
  for(let i=0;i<series.length;i++){
    const endDate = series[i].t;
    const cutoff = new Date(endDate); cutoff.setUTCFullYear(cutoff.getUTCFullYear()-years);
    while(start<i && series[start].t < cutoff) start++;
    const slice = series.slice(start, i+1).map(p=>p.v).sort((a,b)=>a-b);
    const n = slice.length;
    const m = (n%2) ? slice[(n-1)>>1] : 0.5*(slice[n/2-1]+slice[n/2]);
    out.push({ t:endDate, v:m });
  }
  return out;
}
function lastNYears(series, years=10){
  if(!series.length) return [];
  const last = series[series.length-1].t;
  const cut = new Date(last); cut.setUTCFullYear(cut.getUTCFullYear()-years);
  return series.filter(p=>p.t >= cut);
}
function toXY(s){ return { x:s.map(p=>p.t), y:s.map(p=>p.v) }; }

async function loadAll(){
  setBusy(true);
  logEl().textContent = ""; log("Starting loadAll()");
  if(!FRED_API_KEY || FRED_API_KEY === "YOUR_FRED_API_KEY_HERE"){ showErr("Missing FRED_API_KEY in index.html"); setBusy(false); return; }

  const t0 = Date.now();
  const twenty = new Date(); twenty.setUTCFullYear(twenty.getUTCFullYear()-20);
  const startISO = twenty.toISOString().slice(0,10);
  try{
    const [hy, d10, d1, tips] = await Promise.all([
      fredSeries(SERIES.HY_OAS, startISO),
      fredSeries(SERIES.DGS10,  startISO),
      fredSeries(SERIES.DGS1,   startISO),
      fredSeries(SERIES.TIPS10, startISO),
    ]);
    const map1 = new Map(d1.map(p=>[+p.t, p.v]));
    const curve = d10.filter(p=>map1.has(+p.t)).map(p=>({ t:p.t, v:p.v - map1.get(+p.t) }));

    renderChart("hy", "ICE BofA US High Yield OAS (%, trailing 10y median)", hy, rollingMedian(hy,10), "percent");
    renderChart("curve", "10Y – 1Y Treasury Spread (pp, trailing 10y median)", curve, rollingMedian(curve,10), "number");
    renderChart("tips", "10Y TIPS Yield (%, trailing 10y median)", tips, rollingMedian(tips,10), "percent");

    document.getElementById("foot").textContent =
      "OK • " + new Date().toLocaleString() + " • " + ((Date.now()-t0)|0) + " ms";
  } catch(e){
    console.error(e);
    showErr("Load failed:\n" + e.message);
  } finally {
    setBusy(false);
  }
}

function setBusy(on){
  const btn = document.getElementById("refresh");
  btn.disabled = on; btn.textContent = on ? "Refreshing…" : "Refresh";
}

function renderChart(elId, title, series, medSeries, yfmt){
  if(typeof Plotly === "undefined"){ showErr("Plotly failed to load. Try the alternate CDN (uncomment in HTML)."); return; }

  const last10 = lastNYears(series, 10);
  const x0 = last10[0]?.t ?? series[0]?.t ?? new Date(Date.now()-3650*MS_PER_DAY);
  const x1 = last10.at(-1)?.t ?? series.at(-1)?.t ?? new Date();

  const layout = {
    title: { text: title, x: 0, xanchor: "left", font: { size: 14 } },
    margin: { l: 50, r: 10, t: 36, b: 30 },
    paper_bgcolor: "transparent",
    plot_bgcolor: "transparent",
    xaxis: { range: [x0, x1], showgrid: true },
    yaxis: { tickformat: ".2f", showgrid: true },
    legend: { orientation: "h", x: 0, y: 1.1 },
    dragmode: "pan"
  };
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if(prefersDark){
    layout.font = { color: "white" };
    layout.xaxis.gridcolor = "rgba(255,255,255,0.15)";
    layout.yaxis.gridcolor = "rgba(255,255,255,0.15)";
  }

  const traces = [
    { name:"Value", ...toXY(series), mode:"lines", line:{ width:2 } },
    { name:"Trailing 10y median", ...toXY(medSeries), mode:"lines", line:{ width:1, dash:"dash" } },
  ];

  Plotly.newPlot(elId, traces, layout, { responsive:true, displaylogo:false, modeBarButtonsToRemove:["select2d","lasso2d"] });
}

function testAPI(){
  const url = `https://api.stlouisfed.org/fred/series/observations?series_id=DGS10&api_key=${encodeURIComponent(FRED_API_KEY)}&file_type=json&frequency=d&observation_start=2010-01-01`;
  window.open(url, "_blank");
}
</script>
</head>
<body>
  <header>
    <h1>US Indicators (Debug)</h1>
    <button id="refresh" onclick="loadAll()">Refresh</button>
    <button onclick="testAPI()">Test API</button>
  </header>
  <div class="wrap">
    <div id="log" class=""></div>
    <div class="card"><div class="title">ICE BofA US High Yield OAS</div><div id="hy" style="height:280px;"></div></div>
    <div class="card"><div class="title">10Y – 1Y Treasury Spread</div><div id="curve" style="height:280px;"></div></div>
    <div class="card"><div class="title">10Y TIPS Yield</div><div id="tips" style="height:280px;"></div></div>
    <div class="foot" id="foot">Waiting…</div>
  </div>
  <script>
    document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) loadAll(); });
    window.addEventListener("load", loadAll);
  </script>
</body>
</html>
